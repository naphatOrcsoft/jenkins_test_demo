name: Manual Build & Docker to GHCR

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Which branch to build? (leave empty = current branch)'
        required: false
        default: ''
        type: string
      run_tests:
        description: 'Run Maven tests?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      extra_tag:
        description: 'Extra Docker tag (optional, e.g. "staging")'
        required: false
        default: ''
        type: string

permissions:
  contents: read
  packages: write   # needed to push to GHCR

jobs:
  manual-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Show selected options
        run: |
          echo "Target branch : '${{ github.event.inputs.target_branch }}'"
          echo "Run tests     : '${{ github.event.inputs.run_tests }}'"
          echo "Extra tag     : '${{ github.event.inputs.extra_tag }}'"

      - name: Decide branch to checkout
        id: ref
        run: |
          if [ -n "${{ github.event.inputs.target_branch }}" ]; then
            echo "value=${{ github.event.inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            # use the branch/tag this workflow was triggered from
            echo "value=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
          echo "Will checkout ref: $(cat $GITHUB_OUTPUT)"

      - name: Checkout selected branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.value }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Normalize repo name (lowercase)
        id: norm
        run: |
          echo "repo=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Extract tags (sha + pom version)
        id: meta
        run: |
          # short SHA
          echo "sha_tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

          # version from pom.xml
          APP_VERSION=$(grep -m1 '<version>' pom.xml | sed -E 's/.*<version>(.+)<\/version>.*/\1/')
          SAFE_VER=$(echo "$APP_VERSION" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9._-]+/-/g')
          echo "app_version=$SAFE_VER" >> $GITHUB_OUTPUT

      - name: Decide Maven command
        id: mvncmd
        run: |
          if [ "${{ github.event.inputs.run_tests }}" = "true" ]; then
            echo "cmd=mvn -B -ntp verify" >> $GITHUB_OUTPUT
          else
            echo "cmd=mvn -B -ntp -DskipTests package" >> $GITHUB_OUTPUT
          fi

      - name: Compute extra tag
        id: extratag
        run: |
          if [ -n "${{ github.event.inputs.extra_tag }}" ]; then
            echo "value=ghcr.io/$(echo '${{ steps.norm.outputs.repo }}'):${{ github.event.inputs.extra_tag }}" >> $GITHUB_OUTPUT
          else
            echo "value=" >> $GITHUB_OUTPUT
          fi

      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          # Optional: pass Maven command into Docker build if you later use ARG MAVEN_CMD
          build-args: |
            MAVEN_CMD=${{ steps.mvncmd.outputs.cmd }}
          tags: |
            ghcr.io/${{ steps.norm.outputs.repo }}:latest
            ghcr.io/${{ steps.norm.outputs.repo }}:${{ steps.meta.outputs.sha_tag }}
            ghcr.io/${{ steps.norm.outputs.repo }}:${{ steps.meta.outputs.app_version }}
            ${{ steps.extratag.outputs.value }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ steps.norm.outputs.repo }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.title=${{ steps.norm.outputs.repo }}
